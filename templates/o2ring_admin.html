{% extends "base.html" %}

{% block title %}O2Ring Data Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>O2Ring Data Management</h1>
            <p class="text-muted">Upload and manage O2Ring CSV data files</p>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload O2Ring CSV File</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                            <div class="form-text">Only CSV files are accepted. File must have the correct header format.</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Upload File
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Files List Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Uploaded Files</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshFilesList()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="filesList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file and all its data?</p>
                <p class="text-muted" id="deleteFileName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDeleteFileId = null;

// Upload form handling
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('csvFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const spinner = uploadBtn.querySelector('.spinner-border');
    
    if (!fileInput.files[0]) {
        alert('Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    // Show loading state
    uploadBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    fetch('/admin/o2ring/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fileInput.value = '';
            refreshFilesList();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading file');
    })
    .finally(() => {
        uploadBtn.disabled = false;
        spinner.classList.add('d-none');
    });
});

// Load files list
function refreshFilesList() {
    const filesList = document.getElementById('filesList');
    filesList.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    fetch('/admin/o2ring/files')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFilesList(data.files);
        } else {
            filesList.innerHTML = '<div class="alert alert-danger">Error loading files: ' + data.error + '</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        filesList.innerHTML = '<div class="alert alert-danger">Error loading files</div>';
    });
}

// Display files list
function displayFilesList(files) {
    const filesList = document.getElementById('filesList');
    
    if (files.length === 0) {
        filesList.innerHTML = '<div class="text-muted text-center">No files uploaded yet.</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr><th>Filename</th><th>First Data Point</th><th>Duration</th><th>Rows</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>';
    
    files.forEach(file => {
        const firstTime = new Date(file.first_timestamp);
        const lastTime = new Date(file.last_timestamp);
        const duration = Math.round((lastTime - firstTime) / 1000 / 60); // minutes
        
        html += '<tr>';
        html += '<td>' + escapeHtml(file.filename) + '</td>';
        html += '<td>' + firstTime.toLocaleString('en-GB', { 
            timeZone: 'Europe/London',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(',', '') + '</td>';
        html += '<td>' + duration + ' min</td>';
        html += '<td>' + file.row_count.toLocaleString() + '</td>';
        html += '<td>' + new Date(file.uploaded_at).toLocaleString('en-GB', { 
            timeZone: 'Europe/London',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(',', '') + '</td>';
        html += '<td><button class="btn btn-sm btn-outline-secondary" onclick="deleteFile(' + file.id + ', \'' + escapeHtml(file.filename) + '\')">Delete</button></td>';
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    filesList.innerHTML = html;
}

// Delete file
function deleteFile(fileId, filename) {
    currentDeleteFileId = fileId;
    document.getElementById('deleteFileName').textContent = filename;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Confirm delete
document.getElementById('confirmDelete').addEventListener('click', function() {
    if (!currentDeleteFileId) return;
    
    fetch('/admin/o2ring/delete/' + currentDeleteFileId, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('File deleted successfully!');
            refreshFilesList();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting file');
    })
    .finally(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
        currentDeleteFileId = null;
    });
});

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load files list on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshFilesList();
});
</script>
{% endblock %}
