{% extends "base.html" %}

{% block title %}Dashboard - Garmin Heart Rate Analyzer{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Garmin Heart Rate Analyzer</h1>
        <div>
            {% if session.user_role == 'admin' %}
            <a href="{{ url_for('admin') }}" class="btn btn-outline-primary">Admin Panel</a>
            {% endif %}
        </div>
    </div>
    
    <p class="lead">Welcome, {{ session.user_name }}! ({{ session.user_role }})</p>
    
    <!-- Data Display Section (Both Admin and Viewer) -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Daily View</h5>
                </div>
                <div class="card-body">
                    <form id="dailyDataForm">
                        <div class="mb-3">
                            <label for="dailyDate" class="form-label">Select Date:</label>
                            <input type="date" class="form-control" id="dailyDate" name="date" value="{{ today }}">
                        </div>
                        <button type="submit" class="btn btn-primary">Load Data</button>
                    </form>
                    <div id="dailyData" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Weekly View</h5>
                </div>
                <div class="card-body">
                    <form id="weeklyDataForm">
                        <div class="mb-3">
                            <label for="weeklyStartDate" class="form-label">Start Date:</label>
                            <input type="date" class="form-control" id="weeklyStartDate" name="start_date" value="{{ today }}">
                        </div>
                        <button type="submit" class="btn btn-primary">Load Week</button>
                    </form>
                    <div id="weeklyData" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Daily Data Form
document.getElementById('dailyDataForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('dailyDate').value;
    const dataDiv = document.getElementById('dailyData');
    
    dataDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Loading data...</p></div>';
    
    fetch(`/api/data/${date}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('No data found for this date');
        }
        return response.json();
    })
    .then(data => {
        // Create charts for the data
        createDailyCharts(data, dataDiv);
    })
    .catch(error => {
        dataDiv.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
    });
});

// Weekly Data Form
document.getElementById('weeklyDataForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const startDate = document.getElementById('weeklyStartDate').value;
    const dataDiv = document.getElementById('weeklyData');
    
    dataDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Loading data...</p></div>';
    
    fetch(`/api/weekly-data/${startDate}`)
    .then(response => response.json())
    .then(data => {
        createWeeklyCharts(data, dataDiv);
    })
    .catch(error => {
        dataDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
});

// Create daily charts
function createDailyCharts(data, container) {
    const presentationBuckets = data.presentation_buckets;
    const trimpData = data.trimp_data;
    
    let html = `
        <div class="row">
            <div class="col-12 mb-3">
                <div class="alert alert-info">
                    <strong>Summary:</strong> TRIMP: ${data.total_trimp.toFixed(2)}, 
                    Score: ${data.daily_score.toFixed(1)}, 
                    Activity: ${data.activity_type.replace('_', ' ')}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <canvas id="dailyTimeChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="dailyTRIMPChart"></canvas>
            </div>
        </div>`;
    
    container.innerHTML = html;
    
    // Time spent chart
    const timeCtx = document.getElementById('dailyTimeChart').getContext('2d');
    new Chart(timeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(presentationBuckets),
            datasets: [{
                label: 'Minutes',
                data: Object.values(presentationBuckets).map(bucket => bucket.minutes),
                backgroundColor: [
                    '#1f77b4', '#7fb3d3', '#17becf', '#2ca02c',
                    '#ff7f0e', '#ff6b35', '#d62728', '#8b0000'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Time Spent in HR Zones (minutes)'
                }
            }
        }
    });
    
    // TRIMP chart
    const trimpCtx = document.getElementById('dailyTRIMPChart').getContext('2d');
    new Chart(trimpCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(presentationBuckets),
            datasets: [{
                label: 'TRIMP',
                data: Object.values(presentationBuckets).map(bucket => bucket.trimp),
                backgroundColor: [
                    '#1f77b4', '#7fb3d3', '#17becf', '#2ca02c',
                    '#ff7f0e', '#ff6b35', '#d62728', '#8b0000'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'TRIMP by HR Zone'
                }
            }
        }
    });
}

// Create weekly charts
function createWeeklyCharts(data, container) {
    if (data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No data found for this week.</div>';
        return;
    }
    
    const dates = data.map(d => d.date);
    const trimpValues = data.map(d => d.total_trimp);
    const scores = data.map(d => d.daily_score);
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <canvas id="weeklyTRIMPChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="weeklyScoreChart"></canvas>
            </div>
        </div>`;
    
    container.innerHTML = html;
    
    // Weekly TRIMP chart
    const trimpCtx = document.getElementById('weeklyTRIMPChart').getContext('2d');
    new Chart(trimpCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily TRIMP',
                data: trimpValues,
                borderColor: '#1f77b4',
                backgroundColor: 'rgba(31, 119, 180, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Weekly TRIMP Trend'
                }
            }
        }
    });
    
    // Weekly Score chart
    const scoreCtx = document.getElementById('weeklyScoreChart').getContext('2d');
    new Chart(scoreCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Score',
                data: scores,
                borderColor: '#2ca02c',
                backgroundColor: 'rgba(44, 160, 44, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Weekly Score Trend'
                }
            }
        }
    });
}

// Auto-load today's data on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('dailyDataForm').dispatchEvent(new Event('submit'));
    document.getElementById('weeklyDataForm').dispatchEvent(new Event('submit'));
});
</script>
{% endblock %} 