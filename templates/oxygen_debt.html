{% extends "base.html" %}

{% block title %}Oxygen Debt - Garmin Heart Rate Analyzer{% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='js/dashboard-navigation.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart-utilities.js') }}"></script>
<script src="{{ url_for('static', filename='js/data-loading.js') }}"></script>
<script src="{{ url_for('static', filename='js/heart-rate-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/breathing-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/spo2-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/view-management.js') }}"></script>
<script src="{{ url_for('static', filename='js/event-handlers.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-management.js') }}"></script>
<script src="{{ url_for('static', filename='js/notes-management.js') }}"></script>
<script src="{{ url_for('static', filename='js/utility-functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/shared-data-functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/page-initialization.js') }}"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Oxygen Debt Analysis</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" id="areaBtn">Area</button>
                <button type="button" class="btn btn-outline-secondary" id="minutesBtn">Minutes</button>
            </div>
        </div>
    </div>
</div>

<!-- 14 Week Chart Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" id="fourteenWeekTitle">14 Week Overview</h5>
            </div>
            <div class="card-body">
                <div id="fourteenWeekChartContainer" class="chart-container" style="height: 360px;">
                    <canvas id="fourteenWeekChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Two Week Chart Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="twoWeekTitle">Two Week Overview</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="prevWeek">
                            <span>←</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" id="todayBtn">Today</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="nextWeek">
                            <span>→</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="chartContainer" class="chart-container" style="height: 360px;">
                    <canvas id="twoWeekChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'includes/single_date_view.html' %}


{% include 'includes/modals.html' %}


<script>
// Oxygen debt page-specific initialization
let currentMetric = 'area'; // 'area' or 'minutes'

// Initialize the oxygen debt page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize common page elements
    initializePage();
    
    // Setup common event listeners
    setupCommonEventListeners();
    
    // Oxygen debt page-specific event listeners
    document.getElementById('areaBtn').addEventListener('click', () => switchMetric('area'));
    
    // Initialize by loading 14-week data and going to today
    loadFourteenWeekData();
    goToToday();
});



// navigateWeek moved to dashboard-navigation.js

// goToToday moved to dashboard-navigation.js

// Navigate to a specific week in the two-week view
function navigateToWeek(targetDate) {
    // Close single date view and single activity view when navigating
    closeSingleDateView();
    closeSingleActivityView();
    
    // Calculate the two-week period with the target date in the second week
    const { startDate, endDate } = calculateTwoWeekPeriod(targetDate, true);
    
    loadTwoWeekData(startDate, endDate);
}

// navigateSingleDay moved to dashboard-navigation.js

// goToSingleDateToday moved to dashboard-navigation.js

// Switch between area and minutes
function switchMetric(metric) {
    currentMetric = metric;
    
    // Update button states
    document.getElementById('areaBtn').classList.toggle('active', metric === 'area');
    document.getElementById('minutesBtn').classList.toggle('active', metric === 'minutes');
    
    // Reload 14-week data with new metric
    loadFourteenWeekData();
    
    // Reload two-week data with new metric
    if (currentStartDate && currentEndDate) {
        loadTwoWeekData(currentStartDate, currentEndDate);
    }
    
    // Update activities chart if single date view is open and we have a selected date
    const singleDateSection = document.getElementById('singleDateSection');
    if (singleDateSection.style.display !== 'none' && selectedDate) {
        loadActivitiesForDate(selectedDate);
    }
    
    // Update activity HR chart if single activity view is open and we have a selected activity
    const singleActivitySection = document.getElementById('singleActivitySection');
    if (singleActivitySection.style.display !== 'none' && selectedActivity) {
        createActivityHeartRateChart(selectedActivity);
    }
}

// loadTwoWeekData moved to shared-data-functions.js

// loadDateData moved to shared-data-functions.js

// Update the two-week chart
function updateTwoWeekChart(dateLabels, dataResults) {
    const ctx = document.getElementById('twoWeekChart').getContext('2d');
    
    if (twoWeekChart) {
        twoWeekChart.destroy();
    }
    
    // Prepare data for stacked column chart
    const labels = dateLabels.map(dateLabel => {
        // Create a Date object just for display formatting
        const date = new Date(dateLabel + 'T00:00:00');
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = date.getDate();
        return `${dayName} ${dayNum}`;
    });
    
    // Create datasets for oxygen debt zones
    const datasets = oxygenDebtZoneOrder.map(zone => {
        const data = labels.map((_, index) => {
            const dayData = dataResults[index];
            if (!dayData || !dayData.oxygen_debt) {
                return 0;
            }
            
            const oxygenDebt = dayData.oxygen_debt;
            
            if (currentMetric === 'area') {
                if (zone === 'Below 95') return oxygenDebt.area_under_95 || 0;
                if (zone === 'Below 90') return oxygenDebt.area_under_90 || 0;
                if (zone === 'Below 88') return oxygenDebt.area_under_88 || 0;
            } else {
                // Convert seconds to minutes for minutes view
                if (zone === 'Below 95') return Math.round((oxygenDebt.time_under_95 || 0) / 60);
                if (zone === 'Below 90') return Math.round((oxygenDebt.time_under_90 || 0) / 60);
                if (zone === 'Below 88') return Math.round((oxygenDebt.time_under_88 || 0) / 60);
            }
            return 0;
        });
        
        return {
            label: zone,
            data: data,
            backgroundColor: oxygenDebtColors[zone] || '#6c757d',
            borderWidth: 1,
            borderColor: '#ffffff'
        };
    });
    
    // Calculate the maximum value for Y-axis scaling
    let maxValue = 0;
    dataResults.forEach((dayData, index) => {
        if (dayData && dayData.oxygen_debt) {
            const oxygenDebt = dayData.oxygen_debt;
            
            if (currentMetric === 'area') {
                // Calculate total oxygen debt area for this day
                const totalArea = (oxygenDebt.area_under_95 || 0) + 
                                 (oxygenDebt.area_under_90 || 0) + 
                                 (oxygenDebt.area_under_88 || 0);
                maxValue = Math.max(maxValue, totalArea);
            } else {
                // Calculate total oxygen debt minutes for this day
                const totalMinutes = Math.round(((oxygenDebt.time_under_95 || 0) + 
                                               (oxygenDebt.time_under_90 || 0) + 
                                               (oxygenDebt.time_under_88 || 0)) / 60);
                maxValue = Math.max(maxValue, totalMinutes);
            }
        }
    });
    
    // Calculate Y-axis maximum using shared utility (no minimum constraint for oxygen debt)
    const { axisMax: yAxisMax } = calculateAxisScaling(maxValue, true);
    
    twoWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                const canvas = event.native.target;
                const rect = canvas.getBoundingClientRect();
                const x = event.native.x - rect.left;
                const y = event.native.y - rect.top;
                
                // Get the chart area
                const chartArea = twoWeekChart.chartArea;
                if (!chartArea) return;
                
                // Check if click is within the chart area (excluding axes)
                if (x >= chartArea.left && x <= chartArea.right && 
                    y >= chartArea.top && y <= chartArea.bottom) {
                    
                    // Calculate which date column was clicked based on x-coordinate
                    const xAxis = twoWeekChart.scales.x;
                    const clickIndex = xAxis.getValueForPixel(x);
                    
                    if (clickIndex >= 0 && clickIndex < dateLabels.length) {
                        const dateLabel = dateLabels[clickIndex];
                        // Reload the data for this specific date to ensure we have the latest overrides
                        loadDateData(dateLabel).then(dayData => {
                            showSingleDateView(dateLabel, dayData);
                        });
                    }
                }
            },
            onHover: function(event, elements) {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    ticks: {
                        callback: function(value, index) {
                            // Make labels clickable by adding a click handler
                            const label = this.getLabelForValue(value);
                            return label;
                        }
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: currentMetric === 'area' ? 'Oxygen Debt Area' : 'Minutes'
                    },
                    beginAtZero: true,
                    max: yAxisMax
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const dayData = dataResults[dataIndex];
                            if (dayData && dayData.oxygen_debt) {
                                const oxygenDebt = dayData.oxygen_debt;
                                if (currentMetric === 'area') {
                                    const totalArea = (oxygenDebt.area_under_95 || 0) + 
                                                     (oxygenDebt.area_under_90 || 0) + 
                                                     (oxygenDebt.area_under_88 || 0);
                                    return `Total: ${totalArea.toFixed(0)}`;
                                } else {
                                    const totalMinutes = Math.round(((oxygenDebt.time_under_95 || 0) + 
                                                                   (oxygenDebt.time_under_90 || 0) + 
                                                                   (oxygenDebt.time_under_88 || 0)) / 60);
                                    return `Total: ${totalMinutes} Minutes`;
                                }
                            }
                            return '';
                        }
                    }
                }
            },
            plugins: {
                datalabels: {
                    display: function(context) {
                        // Only show labels for the top dataset (last in the stack)
                        return context.datasetIndex === datasets.length - 1;
                    },
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value, context) {
                        // Calculate total for this column
                        const dataIndex = context.dataIndex;
                        const dayData = dataResults[dataIndex];
                        if (dayData && dayData.oxygen_debt) {
                            const oxygenDebt = dayData.oxygen_debt;
                            if (currentMetric === 'area') {
                                const totalArea = (oxygenDebt.area_under_95 || 0) + 
                                                 (oxygenDebt.area_under_90 || 0) + 
                                                 (oxygenDebt.area_under_88 || 0);
                                return totalArea.toFixed(0);
                            } else {
                                // Calculate total minutes from oxygen debt
                                const totalMinutes = Math.round(((oxygenDebt.time_under_95 || 0) + 
                                                               (oxygenDebt.time_under_90 || 0) + 
                                                               (oxygenDebt.time_under_88 || 0)) / 60);
                                return totalMinutes.toFixed(0);
                            }
                        }
                        return '0';
                    },
                    color: '#2c3e50',
                    font: {
                        weight: 'bold',
                        size: 11
                    },
                    offset: 4
                }
            }
        }
    });
}

// updateDateRange moved to dashboard-navigation.js

// Load 14 weeks of data for oxygen debt
function loadFourteenWeekData() {
    showLoading();
    
    // Calculate the 14-week period ending with the current week
    const today = new Date();
    const currentWeekStart = getWeekStart(today);
    const fourteenWeekStart = new Date(currentWeekStart);
    fourteenWeekStart.setDate(currentWeekStart.getDate() - (13 * 7)); // Go back 13 weeks
    
    // Generate array of 98 date labels (14 weeks × 7 days)
    const dateLabels = [];
    const currentDate = new Date(fourteenWeekStart);
    for (let i = 0; i < 98; i++) {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        dateLabels.push(`${year}-${month}-${day}`);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // Load data for all date labels using batch API
    fetch('/api/data/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dates: dateLabels })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Convert batch response to array format expected by chart
            const results = dateLabels.map(dateLabel => data.data[dateLabel] || null);
            updateFourteenWeekChart(dateLabels, results);
        } else {
            console.error('Error loading 14 week data:', data.error);
        }
        hideLoading();
    })
    .catch(error => {
        console.error('Error loading 14 week data:', error);
        hideLoading();
    });
}

// Update 14-week chart for oxygen debt
function updateFourteenWeekChart(dateLabels, dataResults) {
    const ctx = document.getElementById('fourteenWeekChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (fourteenWeekChart) {
        fourteenWeekChart.destroy();
    }
    
    // Group data by week (Monday to Sunday)
    const weeklyData = [];
    const weekLabels = [];
    
    for (let week = 0; week < 14; week++) {
        const weekStart = week * 7;
        const weekEnd = weekStart + 7;
        const weekDates = dateLabels.slice(weekStart, weekEnd);
        const weekData = dataResults.slice(weekStart, weekEnd);
        
        // Aggregate oxygen debt data for this week
        const weekAggregated = aggregateWeekOxygenDebtData(weekData);
        weeklyData.push(weekAggregated);
        
        // Create week label (e.g., "Apr 7")
        const firstDate = new Date(weekDates[0] + 'T00:00:00');
        const weekLabel = firstDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
        });
        weekLabels.push(weekLabel);
    }
    
    // Create datasets for oxygen debt zones
    const datasets = oxygenDebtZoneOrder.map(zone => ({
        label: zone,
        data: weeklyData.map(weekData => weekData[zone] || 0),
        backgroundColor: oxygenDebtColors[zone],
        borderColor: oxygenDebtColors[zone],
        borderWidth: 1
    }));
    
    // Calculate the maximum value for Y-axis scaling
    let maxValue = 0;
    weeklyData.forEach(weekData => {
        const weekTotal = Object.values(weekData).reduce((sum, value) => sum + value, 0);
        maxValue = Math.max(maxValue, weekTotal);
    });
    
    // Calculate Y-axis maximum using shared utility
    const { axisMax: yAxisMax } = calculateAxisScaling(maxValue, true);
    
    fourteenWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: weekLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                const canvas = event.native.target;
                const rect = canvas.getBoundingClientRect();
                const x = event.native.x - rect.left;
                const y = event.native.y - rect.top;
                
                // Get the chart area
                const chartArea = fourteenWeekChart.chartArea;
                if (!chartArea) return;
                
                // Check if click is within the chart area (excluding axes)
                if (x >= chartArea.left && x <= chartArea.right && 
                    y >= chartArea.top && y <= chartArea.bottom) {
                    
                    // Calculate which week column was clicked based on x-coordinate
                    const xAxis = fourteenWeekChart.scales.x;
                    const clickIndex = xAxis.getValueForPixel(x);
                    
                    if (clickIndex >= 0 && clickIndex < weekLabels.length) {
                        // Get the week start date (Monday) for this week
                        const weekStartDate = new Date(dateLabels[clickIndex * 7]);
                        const monday = getWeekStart(weekStartDate);
                        
                        // Navigate to this week in the two-week view
                        navigateToWeek(monday);
                    }
                }
            },
            onHover: function(event, elements) {
                const canvas = event.native.target;
                const rect = canvas.getBoundingClientRect();
                const x = event.native.x - rect.left;
                const y = event.native.y - rect.top;
                
                // Get the chart area
                const chartArea = fourteenWeekChart.chartArea;
                if (!chartArea) return;
                
                // Check if hover is within the chart area (excluding axes)
                if (x >= chartArea.left && x <= chartArea.right && 
                    y >= chartArea.top && y <= chartArea.bottom) {
                    canvas.style.cursor = 'pointer';
                } else {
                    canvas.style.cursor = 'default';
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const weekIndex = context[0].dataIndex;
                            const weekData = weeklyData[weekIndex];
                            const total = Object.values(weekData).reduce((sum, value) => sum + value, 0);
                            return `Total: ${total.toFixed(1)}`;
                        }
                    }
                },
                datalabels: {
                    display: function(context) {
                        // Only show labels for the top dataset (last in the stack)
                        return context.datasetIndex === datasets.length - 1;
                    },
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value, context) {
                        // Calculate total for this week
                        const weekIndex = context.dataIndex;
                        const weekData = weeklyData[weekIndex];
                        const total = Object.values(weekData).reduce((sum, value) => sum + value, 0);
                        return total > 0 ? total.toFixed(1) : '0';
                    },
                    color: '#2c3e50',
                    font: {
                        weight: 'bold',
                        size: 11
                    },
                    offset: 4
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Week Starting'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: currentMetric === 'area' ? 'Oxygen Debt Area' : 'Minutes'
                    },
                    max: yAxisMax
                }
            }
        }
    });
    
    // Update the 14-week title with the date range
    const startDate = new Date(dateLabels[0] + 'T00:00:00');
    const endDate = new Date(dateLabels[dateLabels.length - 1] + 'T00:00:00');
    const startStr = startDate.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric' 
    });
    const endStr = endDate.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
    });
    
    document.getElementById('fourteenWeekTitle').textContent = `${startStr} - ${endStr}`;
}

// Aggregate oxygen debt data for a week
function aggregateWeekOxygenDebtData(weekData) {
    const aggregated = {};
    
    // Initialize all oxygen debt zones with 0
    oxygenDebtZoneOrder.forEach(zone => {
        aggregated[zone] = 0;
    });
    
    // Aggregate data for each day in the week
    weekData.forEach(dayData => {
        if (dayData && dayData.oxygen_debt) {
            const oxygenDebt = dayData.oxygen_debt;
            
            if (currentMetric === 'area') {
                aggregated['Below 95'] += oxygenDebt.area_under_95 || 0;
                aggregated['Below 90'] += oxygenDebt.area_under_90 || 0;
                aggregated['Below 88'] += oxygenDebt.area_under_88 || 0;
            } else {
                // Convert seconds to minutes for minutes view
                aggregated['Below 95'] += Math.round((oxygenDebt.time_under_95 || 0) / 60);
                aggregated['Below 90'] += Math.round((oxygenDebt.time_under_90 || 0) / 60);
                aggregated['Below 88'] += Math.round((oxygenDebt.time_under_88 || 0) / 60);
            }
        }
    });
    
    return aggregated;
}

// Old loadFourteenWeekData and updateFourteenWeekChart functions removed (replaced with oxygen debt versions above)

// Old aggregateWeekData function removed (replaced with aggregateWeekOxygenDebtData above)

// showLoading and hideLoading functions moved to view-management.js

// showSingleDateView function moved to view-management.js

// closeSingleDateView function moved to view-management.js

// showSingleActivityView function moved to view-management.js
// closeSingleActivityView function moved to view-management.js

// downloadActivityCsv and downloadDailyCsv moved to shared-data-functions.js

// SpO2 Editor Functions moved to modal-management.js

// TRIMP Editor Functions moved to modal-management.js

// Manual Activity Functions moved to modal-management.js

// CSV Upload Functions moved to modal-management.js

// loadActivitiesForDate moved to shared-data-functions.js

// Create horizontal bar chart for activities
function createActivitiesChart(activities) {
    const ctx = document.getElementById('activitiesChart').getContext('2d');
    const chartContainer = document.getElementById('activitiesChartContainer');
    
    // Destroy existing chart if it exists
    if (activitiesChart) {
        activitiesChart.destroy();
    }
    
    if (!activities || activities.length === 0) {
        // No activities - show empty chart with message
        chartContainer.style.height = '100px'; // Small height for empty state
        
        // Clear any existing overlay
        const existingOverlay = chartContainer.querySelector('.no-activities-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        activitiesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                }
            }
        });
        
        // Add a message overlay without destroying the canvas
        const overlay = document.createElement('div');
        overlay.className = 'no-activities-overlay d-flex align-items-center justify-content-center h-100';
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        overlay.innerHTML = '<p class="text-muted">No activities for this date</p>';
        chartContainer.appendChild(overlay);
        return;
    }
    
    // Clear any existing overlay
    const existingOverlay = chartContainer.querySelector('.no-activities-overlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Calculate dynamic height based on number of activities
    // Each bar should be about 40px thick, plus some padding for labels and spacing
    const barHeight = 56;
    const padding = 40;
    const legendHeight = 50;
    const totalHeight = (activities.length * barHeight) + padding + legendHeight;
        
    // Update the container height
    chartContainer.style.height = totalHeight + 'px';
    
    // Prepare data for horizontal stacked bar chart
    const labels = activities.map(activity => {
        return activity.activity_name;
    });
    
    // Create datasets for oxygen debt zones (horizontal bars)
    const datasets = oxygenDebtZoneOrder.map(zone => {
        const data = activities.map(activity => {
            // Get oxygen debt data for this activity
            const oxygenDebt = activity.oxygen_debt;
            if (!oxygenDebt) return 0;
            
            if (currentMetric === 'area') {
                if (zone === 'Below 95') return oxygenDebt.area_under_95 || 0;
                if (zone === 'Below 90') return oxygenDebt.area_under_90 || 0;
                if (zone === 'Below 88') return oxygenDebt.area_under_88 || 0;
            } else {
                // Convert seconds to minutes for minutes view
                if (zone === 'Below 95') return Math.round((oxygenDebt.time_under_95 || 0) / 60);
                if (zone === 'Below 90') return Math.round((oxygenDebt.time_under_90 || 0) / 60);
                if (zone === 'Below 88') return Math.round((oxygenDebt.time_under_88 || 0) / 60);
            }
            return 0;
        });
        
        return {
            label: zone,
            data: data,
            backgroundColor: oxygenDebtColors[zone],
            borderColor: oxygenDebtColors[zone],
            borderWidth: 1,
            stack: 'activities'
        };
    });
    
    // Calculate x-axis maximum for oxygen debt data
    let maxValue = 0;
    activities.forEach(activity => {
        if (activity.oxygen_debt) {
            const oxygenDebt = activity.oxygen_debt;
            let activityTotal = 0;
            
            if (currentMetric === 'area') {
                activityTotal = (oxygenDebt.area_under_95 || 0) + 
                               (oxygenDebt.area_under_90 || 0) + 
                               (oxygenDebt.area_under_88 || 0);
            } else {
                // Convert seconds to minutes
                activityTotal = Math.round(((oxygenDebt.time_under_95 || 0) + 
                                          (oxygenDebt.time_under_90 || 0) + 
                                          (oxygenDebt.time_under_88 || 0)) / 60);
            }
            maxValue = Math.max(maxValue, activityTotal);
        }
    });
    
    // Calculate x-axis maximum using shared utility
    const xAxisMax = calculateAxisMaxWithMinimum(maxValue, 100);
    
    // Create the chart
    activitiesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            indexAxis: 'y', // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                const canvas = event.native.target;
                const rect = canvas.getBoundingClientRect();
                const x = event.native.x - rect.left;
                const y = event.native.y - rect.top;
                
                // Get the chart area
                const chartArea = activitiesChart.chartArea;
                if (!chartArea) return;
                
                // Check if click is within the chart area (excluding axes)
                if (x >= chartArea.left && x <= chartArea.right && 
                    y >= chartArea.top && y <= chartArea.bottom) {
                    
                    // Calculate which activity row was clicked based on y-coordinate
                    const yAxis = activitiesChart.scales.y;
                    const clickIndex = yAxis.getValueForPixel(y);
                    
                    if (clickIndex >= 0 && clickIndex < activities.length) {
                        const activity = activities[clickIndex];
                        showSingleActivityView(activity);
                    }
                }
            },
            onHover: function(event, elements) {
                const canvas = event.native.target;
                const rect = canvas.getBoundingClientRect();
                const x = event.native.x - rect.left;
                const y = event.native.y - rect.top;
                
                // Get the chart area
                const chartArea = activitiesChart.chartArea;
                if (!chartArea) {
                    event.native.target.style.cursor = 'default';
                    return;
                }
                
                // Check if hover is within the chart area (excluding axes)
                if (x >= chartArea.left && x <= chartArea.right && 
                    y >= chartArea.top && y <= chartArea.bottom) {
                    event.native.target.style.cursor = 'pointer';
                } else {
                    event.native.target.style.cursor = 'default';
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'nearest',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const value = context.parsed.x;
                            const zone = context.dataset.label;
                            if (currentMetric === 'area') {
                                return `${zone}: ${value.toFixed(0)}`;
                            } else {
                                return `${zone}: ${value.toFixed(0)} minutes`;
                            }
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: currentMetric === 'area' ? 'Oxygen Debt Area' : 'Minutes'
                    },
                    max: xAxisMax
                },
                y: {
                    stacked: true
                }
            },
            elements: {
                bar: {
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }
            }
        }
    });
}

// Create SpO2 chart for daily view
// createSpo2Chart function moved to chart-creation.js

// Create SpO2 chart for activity view
// createActivitySpo2Chart function moved to chart-creation.js

// Create breathing chart for activity view

// Create 24-hour heart rate chart
// createHeartRateChart function moved to chart-creation.js

// Create activity heart rate chart
// createActivityHeartRateChart function moved to chart-creation.js

// Notes Functions moved to notes-management.js

// SpO2 Distribution Functions moved to utility-functions.js


</script>
{% endblock %} 
